---
- name: Get facts by name
  azure_rm_virtualmachine_facts:
    resource_group: "{{ machine_rg }}"
    name: "{{ machine_name }}"
  register: machine_info

- set_fact:
    machine_list: "{{ machine_list  + [ {'name':machine_name, 'rg':machine_rg} ] }}"

- include: add_host.yml
  vars:
    machine_interface: "{{ item }}"
  with_items: "{{ machine_info.vms[0].network_interface_names }}"
  when: machine_info.vms[0].tags.INSTANCEID is defined


